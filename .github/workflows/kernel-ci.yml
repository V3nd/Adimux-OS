name: Adimux Kernel CI v2

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1'  # weekly Monday 03:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev libelf-dev dwarves \
            clang lld llvm pkg-config python3 rsync curl ca-certificates

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup default stable
          rustup component add rust-src

      - name: Checkout latest 6.6.x stable
        run: |
          cd kernel/linux
          git fetch --tags
          git checkout $(git tag -l "v6.6.*" | sort -V | tail -n 1)

      - name: Configure kernel
        run: |
          ./scripts/configure-kernel.sh

      - name: Build kernel
        run: |
          ./scripts/build-kernel.sh

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-artifacts
          path: |
            configs/adimux-final.config
            kernel/linux/arch/x86/boot/bzImage

      - name: LFS userspace smoke validate (tree only)
        run: |
          export LFS="$GITHUB_WORKSPACE/userspace/lfs"
          ./scripts/validate-lfs.sh || true

